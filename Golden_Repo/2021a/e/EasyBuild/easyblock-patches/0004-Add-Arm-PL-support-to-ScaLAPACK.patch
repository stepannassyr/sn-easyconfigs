From 1035d8577fa4569d5c7760b18d3a596c07911d3c Mon Sep 17 00:00:00 2001
From: Stepan Nassyr <s.nassyr@fz-juelich.de>
Date: Mon, 5 Apr 2021 08:46:51 +0200
Subject: [PATCH 04/12] Add Arm PL support to ScaLAPACK

---
 easybuild/easyblocks/s/scalapack.py | 13 +++++++++++--
 1 file changed, 11 insertions(+), 2 deletions(-)

diff --git a/easybuild/easyblocks/s/scalapack.py b/easybuild/easyblocks/s/scalapack.py
index c0e2be50..14b2387e 100644
--- a/easybuild/easyblocks/s/scalapack.py
+++ b/easybuild/easyblocks/s/scalapack.py
@@ -47,6 +47,7 @@ from easybuild.toolchains.linalg.gotoblas import GotoBLAS
 from easybuild.toolchains.linalg.lapack import Lapack
 from easybuild.toolchains.linalg.openblas import OpenBLAS
 from easybuild.toolchains.linalg.intelmkl import IntelMKL
+from easybuild.toolchains.linalg.armblas import ArmBLAS
 from easybuild.tools.build_log import EasyBuildError
 from easybuild.tools.filetools import copy_file, remove_file
 from easybuild.tools.modules import get_software_root
@@ -103,10 +104,11 @@ class EB_ScaLAPACK(CMakeMake):
         # determine build options BLAS and LAPACK libs
         extra_makeopts = []
 
-        acml = get_software_root(Acml.LAPACK_MODULE_NAME[0])
-        lapack = get_software_root(Lapack.LAPACK_MODULE_NAME[0])
+        acml     = get_software_root(Acml.LAPACK_MODULE_NAME[0])
+        lapack   = get_software_root(Lapack.LAPACK_MODULE_NAME[0])
         openblas = get_software_root(OpenBLAS.LAPACK_MODULE_NAME[0])
         intelmkl = get_software_root(IntelMKL.LAPACK_MODULE_NAME[0])
+        armpl    = get_software_root(ArmBLAS.LAPACK_MODULE_NAME[0])
 
         if lapack:
             extra_makeopts.append('LAPACKLIB=%s' % os.path.join(lapack, 'lib', 'liblapack.a'))
@@ -143,6 +145,13 @@ class EB_ScaLAPACK(CMakeMake):
                 'BLASLIB="-L%s %s -lpthread"' % (libdir, blas_libs),
                 'LAPACKLIB="-L%s %s"' % (libdir, blas_libs),
             ])
+        elif armpl:
+            libdir = os.path.join(armpl, 'lib')
+            blas_libs = ' '.join(['-l%s' % lib for lib in ArmBLAS.BLAS_LIB])
+            extra_makeopts.extend([
+                'BLASLIB="-L%s %s -lpthread"' % (libdir, blas_libs),
+                'LAPACKLIB="-L%s %s"' % (libdir, blas_libs),
+            ])
         else:
             raise EasyBuildError("Unknown LAPACK library used, no idea how to set BLASLIB/LAPACKLIB make options")
 
-- 
2.31.1

